<!DOCTYPE html>

<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<script type="text/javascript" src="jquery/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="jquery/jquery-ui-1.10.0.custom.min.js"></script>
<script type="text/javascript" src="select2/select2-3.5.2/select2.min.js"></script>
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
<link type="text/css" href="css/checkmate.css" rel="stylesheet" />
<link type="text/css" href="jquery/css/ui-lightness/jquery-ui-1.10.0.custom.css" rel="stylesheet" />
<link type="text/css" href="select2/select2-3.5.2/select2.css" rel="stylesheet" />
<script type="text/javascript" src="js/global_start.js"></script>
<script type="text/javascript" src="js/resourceful.js"></script>
<script type="text/javascript">
	$(window).load(function() {
		
		//This script extracts parameters from the URL
		//from jquery-howto.blogspot.com
		$.extend({
			getUrlVars : function() {
				var vars = [], hash;
				var hashes = window.location.href.slice(
						window.location.href.indexOf('?') + 1).split('&');
				for ( var i = 0; i < hashes.length; i++) {
					hash = hashes[i].split('=');
					vars.push(hash[0]);
					vars[hash[0]] = hash[1];
				}
				return vars;
			},
			getUrlVar : function(name) {
				return $.getUrlVars()[name];
			}
		});
		
		//console.log($.getUrlVar("tags"));
		
		var tagList = [$.getUrlVar("tags").split("%2C")];
		var searchTags = {}
		for (var i=0; i<tagList.length; i++) {
			searchTags[tagList[i]] = true;
		}
		
		searchResults = [];
		
		{
		
			var resourcesWithRelevancy = [];
			for (var i=0; i<GLOBAL_RESOURCES.length; i++) {
				var resource = GLOBAL_RESOURCES[i];
				var relevancy = 0;
				for (var i=0; i<resource.tags.length; i++) {
					if (searchTags[resource.tags[i]]) {
						relevancy+=10000;
					}
				}
				relevancy+=resource.score;
				
				if (relevancy > 5000) {
					resourcesWithRelevancy.push(
						{
							"resource": resource,
							"relevancy": relevancy,
						}
					);
				}
			}
			
			resourcesWithRelevancy.sort(function(a,b) {
				return a-b;
			});
			
			for (var i=0; i<resourcesWithRelevancy.length; i++) {
				searchResults.push(resourcesWithRelevancy[i].resource);
			}
			
		}
		
		//console.log(JSON.stringify(searchResultsTST));
		
		//#######################################################################################################
		/**
		 * Backend sh*t should actually be happening to determine the search results. 
		 * For now, the results are going to be populated regardless of the tags searched >.>
		 */
		//#######################################################################################################
		
		// MAGIC HAPPENS
		/**
		 * 'results' should be sorted by display order, with results[0] displayed first.
		 * Each result item will be of the form:
		 * {
		 * id: 'Resource id'
		 * name: pls
		 * tags: A list of lower-case strings which are the tags.
		 * description: Short description to be shown under the title
		 * fullDescription: Long description of the resource
		 * score: Upvote/downvote score
		 * vote: User's vote (-1, 0, or 1)
		 * rating: Approximate rating of target audience. An array of two integers.
		 * url: External url
		 * favorite: Boolean, true if this result is favorited by the logged-in user 
		 * reviews: An object containing information about reviews.
		 *   {
		 *   rid: 'Review id'
		 *   text: Review text
		 *   author: Author's username
		 *   uuid: Author's 'unique username id'
		 *   }
		 */
		 /*
		searchResults = [
		{id: 1337420,
		name: "A Primer to Caro-Kann",
		description: "This is an intermediate-level introduction to the Caro-Kann Defense.",
		score: 0,
		vote: 0,
		rating: [1200,1400],
		url: "about:blank",
		favorite: false},
		
		{id: 1337421,
		name: "Aggression in the Opening",
		description: "A quick analysis of how to play the opening in a way that puts pressure on the opponent.",
		score: 10,
		vote: 1,
		rating: [1400,1400],
		url: "google.com",
		favorite: true},
		
		{id: 1337423,
		name: "Rook-King Endgames",
		description: "A thorough discussion of historical Rook-King endgames, and how to quickly analyze and play your own configurations.",
		score: -10,
		vote: -1,
		rating: [1900,2000],
		url: "google.com",
		favorite: true},
		]
		//#######################################################################################################
		*/
		var writeToCookie = function(clear) {
			var out;
			if (clear) {
				out={}
			} else {
				out=JSON.parse(localStorage.storedResultData);
			}
			for (var i=0; i<searchResults.length; i++) {
				out[searchResults[i].id] = {
					"score": searchResults[i].score,
					"vote": searchResults[i].vote,
					"favorite": searchResults[i].favorite,
					"reviews": searchResults[i].reviews,
				};
			}
			localStorage.storedResultData = JSON.stringify(out);
			
		}
		
		//cookie time
		/**
		 * Cookie will be an object containing dynamic values of resources. Cookie[rid] will return the object:
		 * {
		 * score: Upvote/downvote score
		 * vote: User's vote (-1, 0, or 1)
		 * favorite: Boolean, true if this result is favorited by the logged-in user
		 * reviews: An object containing information about reviews.
		 *   {
		 *   rid: 'Review id'
		 *   text: Review text
		 *   author: Author's username
		 *   uuid: Author's 'unique username id'
		 *   }
		 * }
		 */
		try {
			cookies = JSON.parse(localStorage.storedResultData);
			for (var i=0; i<searchResults.length; i++) {
				var stored = cookies[searchResults[i].id];
				if (stored != undefined) {
					searchResults[i].score = cookies[searchResults[i].id].score;
					searchResults[i].vote = cookies[searchResults[i].id].vote;
					searchResults[i].favorite = cookies[searchResults[i].id].favorite;
					searchResults[i].reviews = cookies[searchResults[i].id].reviews;
				}
			}
		} catch (e) {
			writeToCookie(true);
			console.log("Error with local storage. Local storage state has been reset to default.");
		}
		
		//localStorage.clear();
		
		placeTopOfPage();
		
		var placeResult = function(result, i) {
			$("#resultlisting").append("<div class=\"searchresult\">");
			$(".searchresult:last").append("<div class=\"leftcol\"></div><div class=\"rightcol\"></div>");
			$(".leftcol:last").append("<div class=\"name\"></div><div class=\"description\"></div>");
			$(".name:last").append("<a href=\"./summary.html\"></a>")
			$(".name:last > a").text(result.name);
			//$(".name:last").append("<span></span>");
			//$(".name:last > span").text(result.name);
			$(".description:last").append("<span></span>");
			$(".description:last > span").text(result.description);
			$(".rightcol:last").append("<div class=\"buttonpane\"></div><hr width=\"100%\" size=\"1\" style=\"margin:0px; color:gainsboro;\"></hr><div class=\"rating\"></div>");
			if (searchResults[i].favorite) {
				$(".buttonpane:last").append("<div class=\"button\">"+heart_button_filled_html+"</div>");
			} else {
				$(".buttonpane:last").append("<div class=\"button\">"+heart_button_html+"</div>");
			}
			$(".heartbutton:last").click(function() {
				searchResults[i].favorite = !searchResults[i].favorite;
				refreshResults();
				writeToCookie();
			});
			$(".buttonpane:last").append("<div class=\"button\">"+extlink_button_html+"</div><div class=\"scorewidget\"></div>");
			$(".scorewidget:last").append("<div class=\"scorebuttons\"></div>");
			if (result.vote == 0) {
				$(".scorebuttons:last").append("<div>"+up_button_html+"</div><div>"+down_button_html+"</div>");
			} else if (result.vote == 1) {
				$(".scorebuttons:last").append("<div>"+up_button_filled_html+"</div><div>"+down_button_html+"</div>");
			} else {
				$(".scorebuttons:last").append("<div>"+up_button_html+"</div><div>"+down_button_filled_html+"</div>");
			}
			$(".upbutton:last").click(function() {
				if (searchResults[i].vote == 1) {
					searchResults[i].score-=searchResults[i].vote;
					searchResults[i].vote = 0;
					searchResults[i].score+=searchResults[i].vote;
				} else {
					searchResults[i].score-=searchResults[i].vote;
					searchResults[i].vote = 1;
					searchResults[i].score+=searchResults[i].vote;
				}
				refreshResults();
				writeToCookie();
			});
			$(".downbutton:last").click(function() {
				if (searchResults[i].vote == -1) {
					searchResults[i].score-=searchResults[i].vote;
					searchResults[i].vote = 0;
					searchResults[i].score+=searchResults[i].vote;
				} else {
					searchResults[i].score-=searchResults[i].vote;
					searchResults[i].vote = -1;
					searchResults[i].score+=searchResults[i].vote;
				}
				refreshResults();
				writeToCookie();
			});
			
			$(".scorewidget:last").append("<div class=\"score\"><span></span></div>");
			if (result.score > 0) {
				$(".score:last > span").text("+"+result.score);
			} else {
				$(".score:last > span").text(result.score);
			}
			$(".rating:last").append("<span></span>");
			if (result.rating[0] === result.rating[1]) {
				$(".rating:last > span").html("<strong>Elo Rating:</strong> ~"+result.rating[0]);
			} else {
				$(".rating:last > span").html("<strong>Elo Rating:</strong> "+result.rating[0]+"-"+result.rating[1]);
			}
		}
		
		var refreshResults = function() {
			$("#resultlisting *").remove();
			for (var i=0; i<searchResults.length; i++) {
				result = searchResults[i];
				placeResult(result,i);
			}
		}
		
		refreshResults();
		
	});
</script>
</head>
<body>

<!-- i feel so empty -->

<div style="margin-top:10px">
<!--<div style="width:62%; float:right; visibility:hidden;">inazuma is my waifu</div>-->
<div style="width:800px; margin-left:auto; margin-right:auto;">
<br>
<span class="large" style="text-transform:capitalize; color:#1C1C1C">Search Results:</span>
</div>
</div>

<div id="resultlisting" class="resultlisting">
	
</div>

<script type="text/javascript" src="js/global_end.js"></script>

</body>
</html>

<!-- KEEP THIS FOR REFERENCE
<div class="searchresult" >
	<div class="leftcol">
		<div class="name">
			<span>
				Openings for Aggression
			</span>
		</div>
		<div class="description">
			<span>
			Description text should go here. Sometimes the text might go on and on, requiring me to write a lot of random filler text to fill this textbox. Asdf asdf asdf asdf.
			</span>
		</div>
	</div>
	<div class="rightcol">
		<div class="buttonpane">
			<div class="button"><span class="ui-icon ui-icon-heart"></span></div>
			<div class="button"><span class="ui-icon ui-icon-extlink"></span></div>
			<div class="scorewidget">
				<div class="scorebuttons">
					<span class="ui-icon ui-icon-triangle-1-n"></span>
					<span class="ui-icon ui-icon-triangle-1-s"></span>
				</div>
				<div class="score">
					<span>+5</span>
				</div>
			</div>
		</div>
		<hr width="100%" size="1" style="margin:0px; color:gainsboro;"></hr>
		<div class="rating">
			<span>Rating: ~1600</span>
		</div>
	</div>
</div>
-->